---
- set_fact: 
    node: "{{ item }}"

- block:

  - include: attach_network_interfaces.yml
    with_items: "{{ node.network_interfaces }}"

  - ec2:
      instance_type: "{{ node.instance_type}}"
      image: "{{ node.image }}"
      wait: true 
      region: "{{ region }}"
      keypair: "{{ node.keypair }}"
      network_interfaces: "{{ interface_ids }}"
      exact_count: 1
      count_tag: 
        Name: "{{ node.name }}"
      instance_tags:
        group: "{{ node.tag_group }}"
        Name: "{{ node.name }}"
    register: instance_details

  environment:
    AWS_SECRET_ACCESS_KEY: "{{ assumed_role.sts_creds.secret_key }}"
    AWS_ACCESS_KEY_ID: "{{ assumed_role.sts_creds.access_key }}"
    AWS_SESSION_TOKEN: "{{ assumed_role.sts_creds.session_token }}"
